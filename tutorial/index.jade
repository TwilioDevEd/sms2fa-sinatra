.step(
  data-title='How it Works',
  data-file='lib/verification_sender.rb')
  :markdown
    ## About this Application

    This [Sinatra](//www.sinatrarb.com) application example demonstrates how to
    implement an SMS two-factor authentication using Twilio.

    Adding two-factor authentication (2FA) to your web application increases the
    security of your user's data. [Multi-factor
    authentication](//en.wikipedia.org/wiki/Multi-factor_authentication)
    determines the identity of a user in two steps:

    1. First we validate the user with an email and password.
    1. Second, we validate using a mobile device, by sending them a one-time **verification code**.

    Once our user enters the verification code, we know they have received the SMS, and indeed are who they say they are. This is a standard SMS implementation.

    For a slightly more advanced implementation using
    [Authy](//www.twilio.com/authy) One-Touch checkout this
    [tutorial](/docs/tutorials/walkthrough/two-factor-authentication/ruby/sinatra).

    Let's get started!

    ---

    **See Also:**

    * [REST API: Sending SMS or MMS](//www.twilio.com/docs/api/rest/sending-messages)

.step(
  data-title='Generating a Verification Code',
  data-file='lib/code_generator.rb')
  :markdown
    ## Generating a Verification Code

    Once our user logs in we need to send them a _verification code_.

    To generate our _verification code_ we use `Random#rand` which can take a
    _range_ as an argument. Considering the current implementation our _6-digit
    verification code_ could be any number between **100000** and **999999**.

    Next let's look at how we would send this in an SMS with Twilio.

    ---

    **See Also:**

    * [Ruby Docs: Random](//ruby-doc.org/core-2.2.0/Random.html)
    * [Ruby Docs: Range](//ruby-doc.org/core-2.2.0/Range.html)

.step(
  data-title='Sending a Verification Code',
  data-file='lib/message_sender.rb')
  :markdown
    ## Sending a Verification Code

    The Twilio helper library allows us to easily send an SMS.

    First we have to create an instance of a **Twilio Client** with our
    credentials. Now all we have to do to send an SMS using the REST API is to call `client.messages.create()` with the necessary parameters.

    You can find your credentials at your [Twilio Account](//www.twilio.com/user/account/phone-numbers/incoming).

    ---

    **See Also:**

    * [Twilio Ruby Helper Library](//twilio-ruby.readthedocs.org/en/latest/)
    * [Twilio: Sending a Text Message](//twilio-ruby.readthedocs.org/en/latest/usage/messages.html#sending-a-text-message)

.step(
  data-title='Registering a User',
  data-file='routes/users.rb',
  data-highlight='15,18-26')
  :markdown
    ## Registering a User

    When a **user** signs up for our website, this controller creates the **user** and sends them a _verification code_.

    In order to do two-factor authentication we need to make sure we ask for the
    user's **phone number**.

    Let's see how we implemented the `send_verification_to` method.

    ---

    **See Also:**

    * [Sinatra Routes](//www.sinatrarb.com/intro.html#Routes)

.step(
  data-title='Putting It All Together',
  data-file='lib/verification_sender.rb')
  :markdown
    ## Putting It All Together

    Using the building blocks we've created in the previous steps we can now pull it all together.

    Notice we update the user with the _verification code_ since we'll need to look it up to verify the user.

    Let's take a look on how to implement the actual 2-Step verification.

.step(
  data-title='Implementing the 2-Step Verification',
  data-file='routes/confirmations.rb',
  data-highlight='9-22')
  :markdown
    ## Implementing the 2-Step Verification

    When the **user** receives an SMS with the _verification code_ we need to
    ensure the given code is valid.

    This validation is achieved by comparing the user's **verification code**
    with the _verification code_ the user inputs on the form.

    ![Confirm Verification Code](http://howtodocs.s3.amazonaws.com/sms-2fa-authentication.png)

    If the validation was successful the application allows the user to have
    access to the protected content. Otherwise the application will prompt for
    the _verification code_ once again.

    ---

    **See Also:**

    * [DataMapper: Finding Records](//datamapper.org/docs/find.html)

.step
  :markdown
    ## Where to next?

    That's it! We've just implemented an SMS Two-Factor Authenticated
    application. If you're a Ruby developer working with Twilio, you might want
    to check out these other tutorials.

    [**SMS and MMS Notifications**](//www.twilio.com/docs/tutorials/walkthrough/server-notifications/ruby/sinatra)

    Faster than e-mail and less likely to get blocked, text messages are great
    for timely alerts and notifications

    [**Automated Survey**](//www.twilio.com/docs/tutorials/walkthrough/automated-survey/ruby/sinatra)

    Instantly collect structured data from your users with a survey conducted
    over a voice call or SMS text messages.

    ### Did this help?

    Thanks for checking out this tutorial! If you have any feedback
    to share with us, we'd love to hear it. [Contact the Twilio Developer Education Team](mailto:deved-oss@twilio.com) to let us know what you think.
